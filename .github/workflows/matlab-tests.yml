# MATLAB CI - Run Tests on Push
name: MATLAB Tests

on:
  push:
    branches: [ main ]  # Only run on direct pushes to main (after merge)
  pull_request:
    branches: [ main ]  # Run on PRs to main (before merge)

jobs:
  test:
    name: Run MATLAB Tests
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Check out repository
        uses: actions/checkout@v4

      # Set up MATLAB
      - name: Set up MATLAB
        uses: matlab-actions/setup-matlab@v2
        with:
          release: R2025b  # Change to your MATLAB version
          products: >
            Deep_Learning_Toolbox
            Text_Analytics_Toolbox
            Statistics_and_Machine_Learning_Toolbox

      # Set up MATLAB paths
      - name: Set up MATLAB paths
        uses: matlab-actions/run-command@v2
        with:
          command: |
            addpath(genpath('tests/fixtures'));
            savepath;
            fprintf('MATLAB path configured\n');

      # Run tests
      - name: Run MATLAB tests
        uses: matlab-actions/run-tests@v2
        with:
          test-results-junit: test-results/results.xml
          code-coverage-cobertura: code-coverage/coverage.xml

      # Upload test results
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/results.xml

      # Upload coverage report
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: code-coverage/coverage.xml

      # Run validation script
      - name: Run bug fix validation
        uses: matlab-actions/run-command@v2
        with:
          command: |
            results = validate_bug_fixes();
            failed = sum(strcmp({results.status}, 'FAIL'));
            if failed > 0
              error('Validation failed: %d tests failed', failed);
            end
            fprintf('All validation tests passed!\n');

      # Run smoke test
      - name: Run smoke test
        uses: matlab-actions/run-command@v2
        with:
          command: run_smoke_test

      # Check code quality
      - name: Check code quality
        uses: matlab-actions/run-command@v2
        with:
          command: |
            issues = checkcode('+reg/**/*.m', '-id');
            if ~isempty(issues)
              error('Code quality issues found');
            end
            fprintf('Code quality check passed!\n');
